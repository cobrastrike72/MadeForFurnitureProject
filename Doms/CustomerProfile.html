<!-- profile.html -->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #ececec !important;
        }

        .sidebar {
            position: relative;
            left: 10px;
            height: 100%;
            background-color: #f8f9fa;
            padding: 20px;
        }

        .content {
            margin: 10% 25%;
        }

        i {
            cursor: pointer;
        }

        .profileContainer {
            border: 1px solid #dee2e6;
            padding: 20px;
            background-color: #434342;
            color: white !important;
            text-align: center;
        }

        .profileContainer h1 p {
            color: #919697 !important;
        }

        p p {
            color: #919697 !important;
            margin-bottom: 0;
        }

        .navbar-nav a {
            position: relative;
        }

        .navbar-nav a::after {
            position: absolute;
            content: "";
            background-color: #434342;
            width: 0%;
            height: 2px;
            left: 50%;
            bottom: -2%;
            transition: width 0.3s ease, left 0.3s ease;
        }

        /* when we do hover on after then make the following on the after pseudo element */
        .navbar-nav a:hover::after {
            width: 80%;
            left: 10%;
        }

        th,
        td {
            font-weight: 400;
            /* border: 2px solid white; */
            padding: 20px;
            text-align: center;

        }

        th {
            font-weight: 600;
            background-color: #919697;
        }

        .profileContainer {

            border-radius: 10px;
            font-size: large;
            /* text-shadow: 1px 1px gray; */
            font-family: 'Franklin Gothic Medium', 'Arial Narrow', Arial, sans-serif;
            /* box-shadow: 5px 5px 10px gray; */
            color: chocolate;
        }

        .Usericon {
            margin: 0 auto;
            display: flex;
            margin-bottom: 30px;
            justify-content: center;
            font-size: 100px;
            border-radius: 50%;
        }

        #myTable {
            background-color: #434342;
            color: white;
        }

        #staticBackdrop>div>div>div.modal-body>div:nth-child(3) {
            display: flex;
        }

        #staticBackdrop>div>div>div.modal-body>div:nth-child(3)>div.d-flex.justify-content-center.align-items-center {
            transform: translate(-52px, 0px);
            ;
        }

        #staticBackdrop>div>div>div.modal-body>div:nth-child(3)>div.d-flex.justify-content-center.align-items-center>span {
            border: none;
            background-color: white;
        }
    </style>
</head>

<body>
    <div class="container-fluid">
        <!-- NavBar -->
        <div class="row">
            <nav class="navbar navbar-expand-md fs-5 fw-bold fiexed-top">
                <a class="navbar-brand" href="../home.html"><img class="ms-5" style="width: 90px"
                        src="../images/made-logo-desktop.svg" alt="logo"></a>
                <!-- Toggle button for good response in small media -->
                <button class="navbar-toggler me-5" type="button" data-bs-toggle="collapse"
                    data-bs-target="#navbarNavDropdown" aria-controls="navbarSupportedContent" aria-expanded="false"
                    aria-label="Toggle navigation">
                    <i class="fa-solid fa-bars"></i>
                </button>
                <!-- Navigation Bar items -->
                <div class="collapse navbar-collapse" id="navbarNavDropdown">
                    <ul class="navbar-nav ms-auto">
                        <li class="nav-item mx-5 mx-md-2 ">
                            <a class="nav-link active" href="CustomerProfile.html">Profile</a>
                        </li>
                        <li class="nav-item mx-5 ms-md-2 me-lg-5">
                            <a class="nav-link" href="orders_history.html">Orders History</a>
                        </li>
                    </ul>
                </div>
            </nav>
        </div>

        <!-- Profile Content -->
        <div class=" d-flex justify-content-center align-items-center mt-5">
            <div class="row w-100">
                <div class="profileContainer mx-auto mt-5 col-11 col-md-8 col-lg-6 mb-5">
                    <div class="Usericon">
                        <i class="fa-solid fa-user-gear text-light"></i>
                    </div>
                    <h1 class="mb-0 text-center text-success" id="customerName"></h1>
                    <hr>
                    <p id="customerEmail" class="mb-0 d-inline-block"> Email: &nbsp;</p>
                    <hr>
                    <p id="customerAddress" class=" mb-0 d-inline-block">Address: &nbsp;</p>
                    <hr>
                    <p id="customerPhone" class="mb-0 d-inline-block">Phone Number (+20): &nbsp;</p>
                    <hr>
                    <p id="customerRole" class="mb-0 d-inline-block">Role: &nbsp;</p>
                    <hr>

                    <!-- Button to trigger modal to edit profile -->
                    <button type="button" class="btn col-auto mx-auto" data-bs-toggle="modal"
                        data-bs-target="#staticBackdrop">
                        <i id="editIcon" class="fs-2 text-danger fa-solid fa-user-pen"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Modal for editing profile -->
        <form class="needs-validation" novalidate>
            <div class="modal fade" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
                aria-labelledby="staticBackdropLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h1 class="modal-title fs-5" id="staticBackdropLabel">Modify your data</h1>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="form-floating mb-3">
                                <input type="text" class="form-control inputs w-75" id="floatingName"
                                    required pattern="^[A-Za-z\s]{3,}$">
                                <label for="floatingName">Name</label>
                                <div class="valid-feedback">
                                    Looks good!
                                </div>
                                <div class="invalid-feedback">
                                    Name can't be less than 3 chars And can have only have white spaces no special
                                    characters or digits.
                                </div>
                            </div>
                            <div class="mb-3 form-floating">
                                <input type="email" class="form-control inputs w-75" id="floatingEmail"
                                     min="0" required
                                    pattern="^[a-zA-Z][a-zA-Z0-9_\.]*@[a-zA-Z]+.com$">
                                <label for="floatingEmail">E-mail</label>
                                <!-- <span class="input-group-text" id="basic-addon2">EGP</span> -->
                                <div class="valid-feedback">
                                    Looks good!
                                </div>
                                <div class="invalid-feedback">
                                    Please Enter valid E-mail Address.
                                </div>
                            </div>

                            <div class="form-floating mb-3">
                                <input type="password" class="d-inline form-control inputs" id="floatingPassword"
                                    placeholder="Password" required>
                                <div class="d-flex justify-content-center align-items-center" style="height: 58px;">
                                    <span class="eye d-inline-block input-group-text">
                                        <i id="ShowPassword" class="fs-4 fa-solid fa-eye text-center  "></i>
                                    </span>
                                </div>
                                <label for="floatingPassword">Password</label>
                                <div class="valid-feedback">
                                    Looks good!
                                </div>
                                <div class="invalid-feedback">
                                    Password must contain at least one uppercase letter, one lowercase letter, one
                                    digit, one special character, and be at least 8 characters long
                                </div>
                            </div>

                            <div class="form-floating mb-3">
                                <input type="text" class="form-control inputs w-75" id="floatingAddress"
                                    placeholder="Address" required pattern="^[a-zA-Z0-9 ,]{10,}$">
                                <label for="floatingAddress">Address</label>
                                <div class="valid-feedback">
                                    Looks good!
                                </div>
                                <div class="invalid-feedback">
                                    Adress can't be less than 10 characters & can't have special chars except ','
                                </div>
                            </div>

                            <div class="form-floating mb-3">
                                <input type="text" class="form-control w-75 inputs" id="floatingPhone"
                                    placeholder="Phone Number" required pattern="^(010|011|012|015)[0-9]{8}$">
                                <label for="floatingPhone">Phone Number </label>
                                <div class="valid-feedback">
                                    Looks good!
                                </div>
                                <div class="invalid-feedback">
                                    Phone Number must be 11 digits and start with 010|011|012|015.
                                </div>
                            </div>

                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary">Save</button>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
        crossorigin="anonymous"></script>
    <script type="module">

        import { persons as originalPersons } from "../js/database.js";
        import { originalOrders as initialOrders, originalOrders } from "../js/database.js";

        let activeUser = JSON.parse(localStorage.getItem("Active User"));
        if (activeUser.role == null || activeUser.role == "Guest") {
            location = "../home.html";
        }

        if (localStorage.getItem("Persons") == null) {
            let plainPersons = originalPersons.map((item) => item.getPerson());
            localStorage.setItem("Persons", JSON.stringify(plainPersons));
            // console.log(JSON.parse(localStorage.getItem("Persons")));
        }
        let persons = JSON.parse(localStorage.getItem("Persons"));

        // function to check E-mail
        function checkEmail(mail) {
            for (let i = 0; i < persons.length; i++) {
                if (persons[i].email == mail) { return true; }
            }
            return false;
        }
        // function to check E-mail
        function checkPhone(phone) {
            for (let i = 0; i < persons.length; i++) {
                if (persons[i].phone == phone) { return true; }
            }
            return false;
        }


        // Set User Data
        let custname = document.getElementById("customerName");
        let custemail = document.getElementById("customerEmail");
        let custaddress = document.getElementById("customerAddress");
        let custphone = document.getElementById("customerPhone");
        let custrole = document.getElementById("customerRole");

        let namep = document.createElement("p");
        namep.classList.add('d-inline-block');
        let emailp = document.createElement("p");
        emailp.classList.add('d-inline-block');
        let addressp = document.createElement("p");
        addressp.classList.add('d-inline-block');
        let phonep = document.createElement("p");
        phonep.classList.add('d-inline-block');
        let rolep = document.createElement("p");
        rolep.classList.add('d-inline-block');


        namep.innerText += activeUser.name;
        emailp.innerText += activeUser.email;
        addressp.innerText += activeUser.address;
        phonep.innerText += activeUser.phone;
        rolep.innerText += activeUser.role;

        namep.style.color = "white";
        emailp.style.color = "white";
        addressp.style.color = "white";
        phonep.style.color = "white";
        rolep.style.color = "white";

        custname.appendChild(namep)
        custemail.appendChild(emailp)
        custaddress.appendChild(addressp)
        custphone.appendChild(phonep)
        custrole.appendChild(rolep)

        // print order table
        if (localStorage.getItem("originalOrders") == null) {
            localStorage.setItem("originalOrders", JSON.stringify(initialOrders));
        }
        let orders = JSON.parse(localStorage.getItem("originalOrders"));
        let usersOrders = [];
        for (let i = 0; i < orders.length; i++) {
            if (orders[i].customerId == activeUser.id) {
                usersOrders.push(orders[i]);
            }
        }

        let products = JSON.parse(localStorage.getItem("products"));

        function breakOrdersIntoProducts(ordersRow) {
            let target = [];
            let productsId = ordersRow["products"];
            let productsIndices = [];

            for (let i = 0; i < productsId.length; i++) {
                productsIndices.push(products.findIndex(product => product.id == productsId[i]));
            }

            for (let i = 0; i < ordersRow["products"].length; i++) {
                let result = { id: ordersRow["id"], product: products[productsIndices[i]], quantity: ordersRow["quantities"][i], date: ordersRow["date"], status: ordersRow["status"] }
                target.push(result);
            }
            return target;
        }


        function updatePersonsLocalStorage() {
            localStorage.setItem("Persons", JSON.stringify(persons));
        }

        //Show password
        document.getElementById("ShowPassword").addEventListener("click", function () {
            var x = document.getElementById("floatingPassword");
            let showPasswordIcon = document.getElementById("ShowPassword");
            if (x.type === "password") {
                // x.addClass("");
                showPasswordIcon.classList.remove("fa-eye");
                showPasswordIcon.classList.add("fa-eye-slash");
                x.type = "text";
            } else {
                x.type = "password";
                showPasswordIcon.classList.add("fa-eye");
                showPasswordIcon.classList.remove("fa-eye-slash");
            }
        });

        // edit profile
        let operation;
        function editRow(e) {
            document.forms[0].classList.remove("was-validated");
            let UserData = [activeUser.id, activeUser.name, activeUser.email, activeUser.password, activeUser.address, activeUser.phone, activeUser.role];
            //want to replace the row with a form modal
            let inputs = document.querySelectorAll(".inputs");
            for (let i = 0; i < inputs.length; i++) {
                inputs[i].value = UserData[i + 1];
            }
            console.log(UserData);

            let saveButton = document.querySelectorAll("button[type='submit']")[0];
            saveButton.innerHTML = "Save";
            operation = "edit";
        }

        function setPerson(index, values) {
            persons[index].name = values[0];
            persons[index].email = values[1];
            persons[index].password = values[2];
            persons[index].address = values[3];
            persons[index].phone = values[4];
            persons[index].role = activeUser.role;
            updatePersonsLocalStorage();
        }

        function saveNewRow() {
            let index = persons.findIndex(Person => Person.id == activeUser.id);
            let inputs = document.querySelectorAll(".inputs");
            let UserData = [];
            for (let i = 0; i < inputs.length; i++) {
                UserData.push(inputs[i].value);
            }
            setPerson(index, UserData);
            activeUser = (persons[index])
            localStorage.setItem("Active User", JSON.stringify(activeUser))
            location = "CustomerProfile.html";
        }
        let password = document.getElementById("floatingPassword");
        password.addEventListener("input", function () {
            if (!password.value.match(/^(?=.*?[A-Z])(?=.*?[a-z])(?=.*?[0-9])(?=.*?[#?!@$%^&*-]).{8,}$/)) {
                password.classList.remove("is-valid");
                password.classList.add("is-invalid");
            } else {
                password.classList.add("is-valid");
                password.classList.remove("is-invalid");
            }
        });



        document.querySelectorAll('form')[0].addEventListener('submit', function (event) {
            let email = document.getElementById("floatingEmail").value;
            let phone = document.getElementById("floatingPhone").value;
            this.classList.add('was-validated');
            if (this.checkValidity()) {
                if (checkEmail(email) && activeUser.email != email) {
                    event.preventDefault();
                    event.stopPropagation();
                    alert("This email is already in use.");
                    document.forms[0].classList.remove("was-validated");
                    return;
                }
                else if (checkPhone(phone) && activeUser.phone != phone) {
                    event.preventDefault();
                    event.stopPropagation();
                    alert("This phone number is already in use.");
                    document.forms[0].classList.remove("was-validated");
                    return;
                }
                else if (!password.value.match(/^(?=.*?[A-Z])(?=.*?[a-z])(?=.*?[0-9])(?=.*?[#?!@$%^&*-]).{8,}$/)) {
                    event.preventDefault();
                    event.stopPropagation();
                    password.classList.remove("is-valid");
                    // document.forms[0].classList.remove("was-validated");
                    password.classList.add("is-invalid");
                }
                else {
                    saveNewRow(event);
                }
            }
            else {
                event.preventDefault();
                event.stopPropagation();
            }
        });
        document.getElementById("editIcon").addEventListener("click", function (e) { editRow(e); }); // end of edit function
    </script>
</body>

</html>