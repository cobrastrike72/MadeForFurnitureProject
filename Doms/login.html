<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login Page</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,100..1000;1,9..40,100..1000&display=swap"
        rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">

    <style>
        
        :root {
            --bg-color-button: #000;
            --bg-color: white;
        }

        .navbar-nav a {
            position: relative;
        }

        .navbar-nav a::after {
            position: absolute;
            content: "";
            background-color: #434342;
            width: 0%;
            height: 2px;
            left: 50%;
            bottom: -2%;
            transition: width 0.3s ease, left 0.3s ease;
        }

        .navbar-nav a:hover::after {
            width: 80%;
            left: 10%;
        }

        body {
            font-family: "DM Sans", sans-serif;
            overflow-x: hidden;
            background-color: var(--bg-color);

            align-items: center;
            justify-content: center;
            width: 100vw;
            height: 100vh;
        }

        .container-for-register {
            border: 3px solid white;
            box-shadow: -5px 5px 20px gray;
            background-color: white;
            margin: 4% auto;
            border-radius: 10px;
            justify-content: center;
            text-align: center;
        }

        .container-for-register h2 {
            color: black;
            margin: 15px;
        }

        input[type=text],
        input[type=email],
        input[type=password],
        input[type=number] {
            background-color: var(--bg-color);

        }

        .input-group i {
            display: flex;
            justify-content: center;
            height: 58px;
            background-color: transparent;
            border: none;
        }

        .eye {
            height: 80%;
            border-left: 1px solid;
        }

        .eye:hover {
            cursor: pointer;
        }

        .input-group {
            color: black;
            background-color: var(--bg-color);
            border: 2px solid gray;
            border-radius: 5px;
            margin: 2px;
            margin: 10px 0;
        }

        .input-group input {
            width: 103%;
            height: 30px;
        }

        .container-for-register button {
            margin: 10px auto;
            font-size: large;
            font-weight: 500;
            border: 2px solid white;
            background-color: var(--bg-color-button);
            color: rgb(255, 255, 255);
        }

        .container-for-register button:hover {
            background-color: white;
            color: var(--bg-color-button);
            border: 2px solid var(--bg-color-button);
            transition: 0.3s;
        }

        .container-for-register a {
            color: var(--bg-color-button);
            transition: 0.3s;
        }

        .container-for-register a:hover {
            background-color: black;
            color: white;
        }

        .container-for-register a {
            padding-bottom: 30px;
        }

        form a {
            font-weight: bold;
            color: highlight;
        }

        .navbar {
            background-color: white;
        }

        .navbar img {
            width: 40%;
        }
    </style>
</head>

<body>

    <div class="container-fluid overflow-hidden" style="height: 100vh !important">
        <nav class="navbar navbar-expand-md fs-5 fw-bold">

            <a class="navbar-brand  m-0" href="../home.html"><img class=" ms-3 ms-md-5 d-inline-block w-50"
                    src="../images/made-logo-desktop.svg" alt="logo"></a>
            <button class="navbar-toggler me-4 me-md-5" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarNavDropdown" aria-controls="navbarNavDropdown" aria-expanded="false"
                aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNavDropdown">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item ms-3">
                        <a class="nav-link " aria-current="page" href="../home.html">Home</a>
                    </li>
                    <li class="nav-item ms-3 me-md-5">
                        <a class="nav-link" href="./products.html">Products</a>
                    </li>
                </ul>
            </div>
        </nav>
        <main style="min-height: calc(100vh - 56px) !important"
            class="d-flex justify-content-center align-items-center row">

            <div class="main-photo col-4 d-none d-lg-block">
                <img src="../images/Made Furniture.png" alt="" class="w-100">
            </div>
            <div class="main-details col-12 col-lg-8">


                <div class="container-for-register row col-10 col-sm-8 col-md-6 col-lg-6 ">
                    <h2 class="col-12 col-sm-6">Login To Made</h2>
                    <form class="needs-validation" novalidate action="../home.html">
                        <div class="input-group row">
                            <div class="col-1"><i class="fs-3 fa fa-user input-group-text "></i></div>
                            <div class="form-floating">
                                <input required type="text" class="col-auto form-control" id="email"
                                    placeholder="E-mail">
                                <label class="ms-2" for="email">Email</label>
                                <div class="valid-feedback">
                                    Looks Fine!
                                </div>
                                <div class="invalid-feedback">
                                    If you don't have an Account create one now!
                                </div>
                            </div>
                        </div>

                        <div class="row input-group">
                            <div class="col-1"><i class="fs-3 fa fa-lock input-group-prepend input-group-text"></i>
                            </div>
                            <div class=" form-floating">
                                <input required type="password" class="form-control" id="password"
                                    placeholder="Password">
                                <label class="ms-2" for="password">Password</label>
                                <div class="valid-feedback">
                                    Looks Fine!
                                </div>
                                <div class="invalid-feedback">
                                    Please Enter the correct password!
                                </div>
                            </div>
                            <span class="eye col-1 me-3">
                                <i id="ShowPassword" class="fs-4 input-group-text fa-solid fa-eye"></i>
                            </span>
                        </div>

                        <div class="col-12">
                            <button type="submit" class="btn col-12  btn-block">Login</button>
                        </div>
                        <hr />
                        <a class="d-block m-auto text-decoration-none col-lg-5 p-2 mb-3 border border-black border-2 d-flex justify-content-center rounded align-items-center"
                            href="./register.html">Create New Account</a>
                    </form>
                </div>
        </main>
    </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
        crossorigin="anonymous"></script>

    <script type="module">
        import { persons } from "../js/database.js";
        import { Person } from "../js/database.js";

        if (localStorage.getItem("Persons") == null) {
            const Persons = persons.map(personData => {
                return new Person(
                    personData.id,
                    personData.name,
                    personData.email,
                    personData.password,
                    personData.address,
                    personData.phone,
                    personData.role
                ).getPerson();
            });
            console.log(Persons);
            localStorage.setItem("Persons", JSON.stringify(Persons));
        }

        const usersArr = JSON.parse(localStorage.getItem("Persons")).map(userData => {
            return new Person(
                userData.id,
                userData.name,
                userData.email,
                userData.password,
                userData.address,
                userData.phone,
                userData.role
            );
        });

        // Helper function to check if an email exists in users array
        function checkEmail(mail) {
            const userIndex = usersArr.findIndex(user => user.email.toLowerCase() === mail.toLowerCase());
            return userIndex !== -1 ? userIndex + 1 : false; // Return index + 1 to avoid conflict with id of zero
        }

        // Flags for email and password validation
        let emailFlag = false, passwordFlag = false;

        window.addEventListener("load", function () {
            const emailInput = document.getElementById("email");
            const passwordInput = document.getElementById("password");
            const form = document.querySelector('form');
            let showPasswordBtn = document.getElementById("ShowPassword");

            // Email input validation
            emailInput.addEventListener("input", function () {
                const emailValue = this.value;
                const userIndex = checkEmail(emailValue);
                const isValidEmail = /^[a-z][a-z0-9_.]*@[a-z]+\.com$/.test(emailValue);
                if (!isValidEmail) {
                    emailFlag = false;
                    this.classList.add("is-invalid");
                    this.classList.remove("is-valid");
                } else {
                    this.classList.remove("is-invalid");
                    this.classList.add("is-valid");
                }
                if (!userIndex) {
                    emailFlag = false;
                } else {
                    emailFlag = true;
                    // Check password immediately if it's already entered
                    const userPassword = usersArr[userIndex - 1].password;
                    if (passwordInput.value !== userPassword) {
                        passwordFlag = false;
                    } else {
                        passwordFlag = true;
                    }
                }
            });

            // Password input validation
            passwordInput.addEventListener("input", function () {
                const userEmail = emailInput.value;
                const userIndex = checkEmail(userEmail) - 1;
                const userPassword = usersArr[userIndex]?.password; // Ensure undefined safety
                console.log(userPassword);
                const isValidFormatPassword = /^(?=.*?[A-Z])(?=.*?[a-z])(?=.*?[0-9])(?=.*?[#?!@$%^&*-]).{8,}$/.test(this.value);
                console.log(isValidFormatPassword);
                if (!isValidFormatPassword) {
                    passwordFlag = false;
                    this.classList.add("is-invalid");
                    this.classList.remove("is-valid");
                } else {
                    this.classList.remove("is-invalid");
                    this.classList.add("is-valid");
                }
                if (!emailFlag) {
                    passwordFlag = false;
                } else {
                    if (this.value !== userPassword) {
                        passwordFlag = false;
                    } else {
                        passwordFlag = true;
                    }
                }
            });

            // Form submission validation
            form.addEventListener('submit', function (e) {
                if (!emailFlag || !passwordFlag) {
                    e.preventDefault(); // Prevent form submission
                    e.stopPropagation(); // Stop further event propagation
                    if (!emailFlag) {
                        emailInput.classList.add("is-invalid");
                        emailInput.classList.remove("is-valid");
                    }
                    if (!passwordFlag) {
                        passwordInput.classList.add("is-invalid");
                        passwordInput.classList.remove("is-valid");
                    }
                } else {
                    const userEmail = emailInput.value;
                    const userIndex = checkEmail(userEmail) - 1;
                    localStorage.setItem("Active User", JSON.stringify(usersArr[userIndex].getPerson()));
                    e.target.classList.add('was-validated'); // Add Bootstrap validation class
                }
            });

            // Show/hide password toggle
            showPasswordBtn.addEventListener("click", function () {
                passwordInput.type = passwordInput.type === "password" ? "text" : "password";
                if (showPasswordBtn.classList.contains("fa-eye")) {
                    console.log("Toggle to hide password");
                    showPasswordBtn.classList.remove("fa-eye");
                    showPasswordBtn.classList.add("fa-eye-slash");
                } else {
                    showPasswordBtn.classList.remove("fa-eye-slash");
                    showPasswordBtn.classList.add("fa-eye");
                }
            });
        });

    </script>

</body>

</html>